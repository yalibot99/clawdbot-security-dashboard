<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÑ‚Äç‚ôÇÔ∏è Ayali's Wing Foil Forecast</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0a192f;
            --bg-secondary: #112240;
            --bg-tertiary: #1d3557;
            --text-primary: #e6f1ff;
            --text-secondary: #8892b0;
            --accent: #64ffda;
            --accent-dark: #00bfa5;
            --ocean: #0077be;
            --waves: #00a8cc;
            --wind: #a8dadc;
            --danger: #ff6b6b;
            --warning: #ffd93d;
            --success: #6bcb77;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--ocean) 100%);
            color: var(--text-primary);
            font-family: 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            padding: 1.5rem;
        }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        .header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: rgba(17, 34, 64, 0.85);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .header h1 span { color: var(--accent); }
        
        .location-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            margin-top: 0.75rem;
            font-size: 0.9rem;
        }
        
        .spot-input {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .spot-input input {
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--text-secondary);
            background: var(--bg-primary);
            color: var(--text-primary);
            width: 120px;
            font-size: 0.9rem;
        }
        
        .spot-input button {
            padding: 0.4rem 1rem;
            border-radius: 8px;
            border: none;
            background: var(--accent);
            color: var(--bg-primary);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .windy-btn {
            background: linear-gradient(135deg, #1e8c99 0%, #2eb8b8 100%);
            color: white;
        }
        .windy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 184, 184, 0.4);
        }
        
        .best-time {
            background: linear-gradient(135deg, var(--accent) 0%, var(--ocean) 100%);
            padding: 1.5rem;
            border-radius: 16px;
            text-align: center;
            margin: 1.5rem 0;
        }
        
        .best-time h2 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            opacity: 0.9;
        }
        
        .best-time .time {
            font-size: 3rem;
            font-weight: 800;
        }
        
        .best-time .conditions {
            font-size: 1rem;
            margin-top: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: inline-block;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
        }
        
        .metric-card {
            background: rgba(17, 34, 64, 0.85);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .metric-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .metric-card .label {
            color: var(--text-secondary);
            margin-top: 0.25rem;
            font-size: 0.85rem;
        }
        
        .why-section {
            background: rgba(17, 34, 64, 0.85);
            padding: 1.25rem;
            border-radius: 12px;
            margin: 1.5rem 0;
        }
        
        .why-section h3 {
            color: var(--accent);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }
        
        .why-section p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .wind-indicator {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .wind-good { background: var(--success); color: var(--bg-primary); }
        .wind-fair { background: var(--warning); color: var(--bg-primary); }
        .wind-bad { background: var(--danger); color: white; }
        
        .wave-indicator {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .wave-low { background: var(--success); color: var(--bg-primary); }
        .wave-med { background: var(--warning); color: var(--bg-primary); }
        .wave-high { background: var(--danger); color: white; }
        
        .forecast-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        
        .forecast-table th,
        .forecast-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .forecast-table th {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .source-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        
        .source-info strong { color: var(--accent); }
        
        .wind-summary {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-primary);
        }
        
        .wind-summary strong {
            color: var(--accent);
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .back-link:hover { color: var(--accent); }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to Security Dashboard</a>
        
        <div class="header">
            <h1>üèÑ‚Äç‚ôÇÔ∏è Ayali's <span>Wing Foil</span> Forecast</h1>
            <div class="location-badge">
                üìç <span id="spot-name">Tel Aviv Beach</span>
                <span id="coords">(32.0853, 34.7818)</span>
            </div>
            
            <div class="spot-input">
                <input type="text" id="lat" placeholder="Lat" value="32.0853">
                <input type="text" id="lon" placeholder="Lon" value="34.7818">
                <button onclick="updateForecast()">Get Forecast</button>
                <a id="windy-link" href="#" target="_blank" class="btn windy-btn" style="text-decoration: none; padding: 0.4rem 1rem; border-radius: 8px; display: none;">
                    üó∫Ô∏è View on Windy
                </a>
            </div>
        </div>
        
        <div class="best-time" id="best-time">
            <h2>üåä Best Time for Wing Foil Tomorrow</h2>
            <div class="time" id="best-hour">--:--</div>
            <div class="conditions" id="best-conditions">Loading...</div>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="value" id="wind-speed">--</div>
                <div class="label">üí® Wind (km/h)</div>
            </div>
            <div class="metric-card">
                <div class="value" id="wind-dir">--</div>
                <div class="label">üß≠ Wind Direction</div>
            </div>
            <div class="metric-card">
                <div class="value" id="wave-height">--</div>
                <div class="label">üåä Wave Height</div>
            </div>
            <div class="metric-card">
                <div class="value" id="foil-score">--</div>
                <div class="label">üî• Foil Score</div>
            </div>
        </div>
        
        <div class="why-section" id="why-section">
            <h3>üìù Why This is the Best Time</h3>
            <p id="why-text">Loading analysis...</p>
        </div>
        
        <div class="why-section">
            <h3>üìã Hourly Forecast (Morning 6-10 AM)</h3>
            <table class="forecast-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Wind</th>
                        <th>Waves</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="forecast-body">
                    <tr><td colspan="4" style="text-align: center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="why-section" id="wind-summary-section">
            <h3>üí® Wind Conditions Today</h3>
            <p id="wind-summary-text" class="wind-summary">Loading...</p>
        </div>
        
        <div class="why-section">
            <h3>üìä All Day Wind Forecast</h3>
            <table class="forecast-table" id="all-hours-table">
                <thead>
                    <tr>
                        <th>Hour</th>
                        <th>Wind Speed</th>
                        <th>Direction</th>
                        <th>Rating</th>
                    </tr>
                </thead>
                <tbody id="all-hours-body">
                    <tr><td colspan="4" style="text-align: center;">Loading full day forecast...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="source-info" id="source-info">
            <strong>Data:</strong> <span id="data-source">Loading...</span><br>
            <strong>Updated:</strong> <span id="data-updated">Loading...</span>
        </div>
    </div>
    
    <script>
        async function updateForecast() {
            const lat = document.getElementById('lat').value;
            const lon = document.getElementById('lon').value;
            
            document.getElementById('spot-name').textContent = `${lat}, ${lon}`;
            document.getElementById('coords').textContent = `(${lat}, ${lon})`;
            
            // Update Windy link
            const windyLink = document.getElementById('windy-link');
            windyLink.href = `https://www.windy.com/?${lat},${lon},8`;
            windyLink.style.display = 'inline-flex';
            
            try {
                const response = await fetch(`/api/surf/forecast?lat=${lat}&lon=${lon}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Update source info
                document.getElementById('data-source').textContent = data.source || 'Unknown';
                document.getElementById('data-updated').textContent = data.updated ? new Date(data.updated).toLocaleString() : 'Unknown';
                
                // Update wind summary
                document.getElementById('wind-summary-text').innerHTML = data.wind_summary || 'No wind data available.';
                
                // Update best time
                if (data.best_time) {
                    const best = data.best_time;
                    document.getElementById('best-hour').textContent = best.time;
                    document.getElementById('best-conditions').textContent = best.conditions;
                    
                    document.getElementById('wind-speed').textContent = `${best.wind_speed?.toFixed(0) || '--'} km/h`;
                    document.getElementById('wave-height').textContent = `${best.wave_height?.toFixed(1) || '--'}m`;
                    document.getElementById('foil-score').textContent = best.score?.toFixed(0) || '--';
                    document.getElementById('wind-dir').textContent = best.wind_dir_name || '--';
                    
                    // Generate why text
                    generateWhyText({
                        wind_speed: best.wind_speed,
                        wind_direction: best.wind_direction,
                        wave_height: best.wave_height
                    });
                }
                
                // Update morning table
                const tbody = document.getElementById('forecast-body');
                tbody.innerHTML = '';
                
                if (data.morning_surf && data.morning_surf.length > 0) {
                    data.morning_surf.forEach(entry => {
                        let windClass = 'wind-bad';
                        let windText = '‚ùå';
                        if (entry.wind_speed >= 15 && entry.wind_speed <= 40) {
                            windClass = 'wind-good';
                            windText = '‚úÖ Perfect';
                        } else if (entry.wind_speed >= 10 && entry.wind_speed < 50) {
                            windClass = 'wind-fair';
                            windText = '‚ö†Ô∏è OK';
                        }
                        
                        let waveClass = 'wave-low';
                        let waveText = '‚úÖ Calm';
                        if (entry.wave_height > 1.0) {
                            waveClass = 'wave-high';
                            waveText = '‚ùå Choppy';
                        } else if (entry.wave_height > 0.5) {
                            waveClass = 'wave-med';
                            waveText = '‚ö†Ô∏è Moderate';
                        }
                        
                        const score = entry.score || 0;
                        let scoreClass = '‚ùå';
                        if (score > 40) scoreClass = 'üî•';
                        else if (score > 20) scoreClass = '‚úÖ';
                        else if (score > 0) scoreClass = '‚ö†Ô∏è';
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>${entry.hour}:00</td>
                                <td><span class="wind-indicator ${windClass}">${windText}</span></td>
                                <td><span class="wave-indicator ${waveClass}">${waveText}</span></td>
                                <td>${score.toFixed(0)} ${scoreClass}</td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No morning data available</td></tr>';
                }
                
                // Update ALL hours table
                const allHoursBody = document.getElementById('all-hours-body');
                allHoursBody.innerHTML = '';
                
                if (data.all_hours && data.all_hours.length > 0) {
                    data.all_hours.forEach(entry => {
                        // Wind rating
                        let windClass = 'wind-bad';
                        let windText = '‚ùå Light';
                        if (entry.wind_speed >= 40) {
                            windClass = 'wind-bad';
                            windText = 'üí® Strong';
                        } else if (entry.wind_speed >= 15) {
                            windClass = 'wind-good';
                            windText = '‚úÖ Good';
                        } else if (entry.wind_speed >= 10) {
                            windClass = 'wind-fair';
                            windText = '‚ö†Ô∏è Light';
                        }
                        
                        allHoursBody.innerHTML += `
                            <tr>
                                <td>${entry.hour}:00</td>
                                <td>${entry.wind_speed?.toFixed(1) || '--'} km/h</td>
                                <td>${entry.wind_dir_name || '--'}</td>
                                <td><span class="wind-indicator ${windClass}">${windText}</span></td>
                            </tr>
                        `;
                    });
                } else {
                    allHoursBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hourly data available</td></tr>';
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('why-text').textContent = 'Failed to load forecast data.';
            }
        }
        
        function generateWhyText(entry) {
            const parts = [];
            
            // Wind analysis
            if (entry.wind_speed >= 15 && entry.wind_speed <= 40) {
                parts.push(`üí® ${entry.wind_speed.toFixed(0)} km/h wind is perfect for wing foiling ‚Äî enough power to stay up, not too much to handle.`);
            } else if (entry.wind_speed < 15) {
                parts.push(`üí® Wind is light (${entry.wind_speed.toFixed(0)} km/h) ‚Äî may struggle for lift.`);
            } else if (entry.wind_speed > 40) {
                parts.push(`üí® Strong winds (${entry.wind_speed.toFixed(0)} km/h) ‚Äî advanced conditions,ÊÖéÈáç„Å™Âà§Êñ≠„ÅåÂøÖË¶Å (be careful).`);
            }
            
            // Wave analysis
            if (entry.wave_height <= 0.5) {
                parts.push(`üåä Calm waters (${entry.wave_height.toFixed(1)}m) ‚Äî ideal for learning and maintaining speed on the foil.`);
            } else if (entry.wave_height > 1.0) {
                parts.push(`üåä Choppy conditions (${entry.wave_height.toFixed(1)}m) ‚Äî waves can destabilize the foil.`);
            }
            
            // Wind direction
            if (entry.wind_direction !== null) {
                const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
                const dir = dirs[Math.round(entry.wind_direction / 45) % 8];
                parts.push(`üß≠ Wind from ${dir} ‚Äî ${getWindAdvice(entry.wind_direction)}`);
            }
            
            document.getElementById('why-text').innerHTML = parts.join('<br><br>');
        }
        
        function getWindAdvice(degrees) {
            // Simplified offshore/offshore advice
            if (degrees >= 315 || degrees < 45) return 'cross-shore ‚Äî stable conditions';
            if (degrees >= 45 && degrees < 135) return 'onshore ‚Äî may be choppy';
            if (degrees >= 135 && degrees < 225) return 'offshore ‚Äî powerful but can be gusty';
            return 'cross-shore ‚Äî good conditions';
        }
        
        document.addEventListener('DOMContentLoaded', updateForecast);
    </script>
</body>
</html>
